<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Workplace Scanner</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#0b0d12;
  color:#e8eaf0;
}
header{
  padding:14px 16px;
  background:#0f1320;
  border-bottom:1px solid #22283a;
}
main{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#11172a;
  border:1px solid #1f2740;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap}
button,select,input{
  background:#25304f;
  color:#fff;
  border:0;
  padding:10px;
  border-radius:10px;
}
button{font-weight:700}
video{
  width:100%;
  border-radius:12px;
  border:1px solid #223055;
}
#scanBox{
  position:absolute;
  top:25%;
  left:10%;
  right:10%;
  height:30%;
  border:3px solid #2b67f6;
  border-radius:12px;
  pointer-events:none;
}
.result{
  border:1px dashed #3a4a7a;
  border-radius:12px;
  padding:12px;
}
.price{font-size:36px;font-weight:900}
.muted{color:#aab3cf;font-size:13px}
.hidden{display:none}
</style>
</head>

<body>
<header>
  <h2>Workplace Barcode / SKU Scanner</h2>
</header>

<main>

<!-- CAMERA -->
<div class="card">
  <div class="row">
    <select id="cameraSelect">
      <option value="environment">Back Camera</option>
      <option value="user">Front Camera</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="focusBtn" disabled>Focus</button>
    <button id="torchBtn" disabled>Flashlight</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div style="position:relative;margin-top:10px">
    <video id="video" playsinline muted></video>
    <div id="scanBox"></div>
  </div>
</div>

<!-- LOOKUP -->
<div class="card">
  <h3>Manual Lookup</h3>
  <div class="row">
    <input id="skuLookup" placeholder="Lookup by SKU / Barcode">
    <button id="skuBtn">Lookup SKU</button>
  </div>
  <div class="row" style="margin-top:8px">
    <input id="nameLookup" placeholder="Lookup by name / description">
    <button id="nameBtn">Search Name</button>
  </div>
</div>

<!-- RESULT -->
<div class="card">
  <h3>Result</h3>
  <div id="result" class="result muted">Waiting for scan or lookupâ€¦</div>
</div>

<!-- UNKNOWN -->
<div class="card hidden" id="unknownCard">
  <h3>Register Unknown Product</h3>
  <input id="u_name" placeholder="Product name">
  <input id="u_price" type="number" step="0.01" placeholder="Price">
  <input id="u_dept" placeholder="Department">
  <button id="saveUnknown">Save Product</button>
</div>

<button id="exportBtn" class="hidden">Download updated items.json</button>

</main>

<script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>

<script>
const video = document.getElementById("video");
const resultEl = document.getElementById("result");
const unknownCard = document.getElementById("unknownCard");
const exportBtn = document.getElementById("exportBtn");

let items = [];
let itemsMap = new Map();
let reader, stream, track;
let lastCode = "";

async function loadItems(){
  const res = await fetch("./items.json",{cache:"no-store"});
  items = await res.json();
  itemsMap = new Map(items.map(i=>[String(i.barcode),i]));
}

function displayItem(item){
  resultEl.innerHTML = `
    <div class="price">$${item.price}</div>
    <b>${item.name}</b><br>
    <span class="muted">${item.department||""}</span>
  `;
  unknownCard.classList.add("hidden");
}

function handleCode(code){
  lastCode = code;
  const item = itemsMap.get(code);
  if(item) displayItem(item);
  else{
    resultEl.innerHTML = `<b>Unknown SKU:</b><br>${code}`;
    unknownCard.classList.remove("hidden");
  }
}

async function start(){
  await loadItems();

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.TRY_HARDER,true);

  reader = new ZXing.BrowserMultiFormatReader(hints);
  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:cameraSelect.value}
  });

  video.srcObject = stream;
  await video.play();

  track = stream.getVideoTracks()[0];
  if(track.getCapabilities?.().torch) torchBtn.disabled=false;
  focusBtn.disabled=false;
  stopBtn.disabled=false;
  startBtn.disabled=true;

  reader.decodeFromVideoElement(video,(res)=>{
    if(res) handleCode(res.getText());
  });
}

function stop(){
  reader?.reset();
  stream?.getTracks().forEach(t=>t.stop());
  startBtn.disabled=false;
  stopBtn.disabled=true;
}

async function focus(){
  if(track?.applyConstraints){
    try{
      await track.applyConstraints({advanced:[{focusMode:"continuous"}]});
    }catch{}
  }
}

async function torch(){
  if(track?.applyConstraints){
    track.torchOn=!track.torchOn;
    await track.applyConstraints({advanced:[{torch:track.torchOn}]});
  }
}

// SKU lookup
skuBtn.onclick=()=>{
  const v = skuLookup.value.trim();
  if(v) handleCode(v);
};

// Name lookup
nameBtn.onclick=()=>{
  const q = nameLookup.value.toLowerCase();
  const found = items.find(i =>
    i.name?.toLowerCase().includes(q) ||
    i.note?.toLowerCase().includes(q)
  );
  if(found) displayItem(found);
  else resultEl.innerHTML="No matching product found";
};

// Save unknown
saveUnknown.onclick=()=>{
  const item={
    barcode:lastCode,
    name:u_name.value,
    price:Number(u_price.value),
    department:u_dept.value
  };
  items.push(item);
  itemsMap.set(lastCode,item);
  exportBtn.classList.remove("hidden");
  alert("Saved locally. Download JSON to commit.");
};

exportBtn.onclick=()=>{
  const blob=new Blob([JSON.stringify(items,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="items.json";
  a.click();
};

startBtn.onclick=start;
stopBtn.onclick=stop;
focusBtn.onclick=focus;
torchBtn.onclick=torch;
</script>
</body>
</html>
