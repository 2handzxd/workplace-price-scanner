<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Workplace Scanner</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#0b0d12;
  color:#e8eaf0;
}
header{
  padding:14px 16px;
  background:#0f1320;
  border-bottom:1px solid #22283a;
}
main{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#11172a;
  border:1px solid #1f2740;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap}
button,select,input{
  background:#25304f;
  color:#fff;
  border:0;
  padding:10px;
  border-radius:10px;
}
button{font-weight:700}
video{
  width:100%;
  border-radius:12px;
  border:1px solid #223055;
}
#overlay{
  position:relative;
}
#scanBox{
  position:absolute;
  top:25%;
  left:10%;
  right:10%;
  height:30%;
  border:3px solid #2b67f6;
  border-radius:12px;
  pointer-events:none;
}
.result{
  border:1px dashed #3a4a7a;
  border-radius:12px;
  padding:12px;
}
.price{font-size:36px;font-weight:900}
.muted{color:#aab3cf;font-size:13px}
.hidden{display:none}
canvas{width:100%;border-radius:12px;border:1px solid #223055}
</style>
</head>

<body>
<header>
  <h2>Workplace Barcode / SKU Scanner</h2>
</header>

<main>

<!-- CAMERA -->
<div class="card">
  <div class="row">
    <select id="cameraSelect">
      <option value="environment">Back Camera</option>
      <option value="user">Front Camera</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="torchBtn" disabled>Flashlight</button>
    <button id="snapBtn" disabled>Take Picture</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div id="overlay" style="margin-top:10px">
    <video id="video" playsinline muted></video>
    <div id="scanBox"></div>
  </div>

  <canvas id="photoCanvas" class="hidden"></canvas>
</div>

<!-- RESULT -->
<div class="card">
  <h3>Scan Result</h3>
  <div id="result" class="result muted">Waiting for scanâ€¦</div>
</div>

<!-- UNKNOWN FORM -->
<div class="card hidden" id="unknownCard">
  <h3>Register Unknown Product</h3>

  <div class="row">
    <input id="u_name" placeholder="Product name">
    <input id="u_price" type="number" step="0.01" placeholder="Price">
  </div>

  <div class="row">
    <input id="u_dept" placeholder="Department">
    <input id="u_location" placeholder="Location">
  </div>

  <button id="saveUnknown">Save Product</button>
</div>

<button id="exportBtn" class="hidden">Download updated items.json</button>

</main>

<script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("photoCanvas");
const ctx = canvas.getContext("2d",{willReadFrequently:true});

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const snapBtn = document.getElementById("snapBtn");
const torchBtn = document.getElementById("torchBtn");
const cameraSelect = document.getElementById("cameraSelect");

const resultEl = document.getElementById("result");
const unknownCard = document.getElementById("unknownCard");
const exportBtn = document.getElementById("exportBtn");

let items = new Map();
let localItems = [];
let reader;
let stream;
let track;
let lastCode = "";

async function loadItems(){
  const res = await fetch("./items.json",{cache:"no-store"});
  const json = await res.json();
  items = new Map(json.map(i=>[String(i.barcode),i]));
}

function showResult(code){
  lastCode = code;
  const item = items.get(code);

  if(item){
    resultEl.innerHTML = `
      <div class="price">$${item.price}</div>
      <b>${item.name}</b><br>
      <span class="muted">${item.department || ""}</span>
    `;
    unknownCard.classList.add("hidden");
  }else{
    resultEl.innerHTML = `<b>Unknown Code:</b><br>${code}`;
    unknownCard.classList.remove("hidden");
  }
}

async function start(){
  await loadItems();

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.TRY_HARDER,true);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:cameraSelect.value}
  });

  video.srcObject = stream;
  await video.play();

  track = stream.getVideoTracks()[0];
  if(track.getCapabilities?.().torch) torchBtn.disabled=false;

  startBtn.disabled=true;
  stopBtn.disabled=false;
  snapBtn.disabled=false;

  reader.decodeFromVideoElement(video,(result)=>{
    if(result){
      const code = result.getText();
      showResult(code);
    }
  });
}

function stop(){
  reader?.reset();
  stream?.getTracks().forEach(t=>t.stop());
  startBtn.disabled=false;
  stopBtn.disabled=true;
  snapBtn.disabled=true;
}

async function toggleTorch(){
  if(!track) return;
  await track.applyConstraints({advanced:[{torch:!track.torchOn}]});
  track.torchOn=!track.torchOn;
}

async function snap(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);

  try{
    const result = await reader.decodeFromCanvas(canvas);
    if(result) showResult(result.getText());
  }catch{
    alert("No barcode found in picture");
  }
}

document.getElementById("saveUnknown").onclick=()=>{
  const item={
    barcode:lastCode,
    name:u_name.value,
    price:Number(u_price.value),
    department:u_dept.value,
    location:u_location.value
  };
  localItems.push(item);
  items.set(lastCode,item);
  exportBtn.classList.remove("hidden");
  alert("Saved locally. Download JSON to commit.");
};

exportBtn.onclick=()=>{
  const data=[...items.values()];
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="items.json";
  a.click();
};

startBtn.onclick=start;
stopBtn.onclick=stop;
snapBtn.onclick=snap;
torchBtn.onclick=toggleTorch;
</script>
</body>
</html>
