<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workplace Price Scanner</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0d12; color: #e8eaf0; }
    header { padding: 16px 18px; border-bottom: 1px solid #22283a; background: #0f1320; }
    header h1 { margin: 0; font-size: 18px; }
    main { max-width: 1040px; margin: 0 auto; padding: 18px; display: grid; gap: 16px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1.2fr 0.8fr; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card { background: #11172a; border: 1px solid #1f2740; border-radius: 14px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      background: #2b67f6; color: #fff; border: 0; padding: 10px 12px;
      border-radius: 10px; cursor: pointer; font-weight: 700;
    }
    button.secondary { background: #25304f; }
    button.danger { background: #7a2230; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    input, select {
      background: #0b1020; border: 1px solid #243056; color: #e8eaf0;
      padding: 10px 12px; border-radius: 10px; width: 100%;
      box-sizing: border-box;
    }

    #videoWrap { position: relative; overflow: hidden; border-radius: 14px; border: 1px solid #223055; background: #070a12; }
    video { width: 100%; height: auto; display: block; }
    #overlay {
      position: absolute; inset: 0; pointer-events: none;
      display: grid; place-items: center;
    }
    #overlay .box {
      width: min(72%, 520px);
      aspect-ratio: 2.2 / 1;
      border: 3px solid rgba(43,103,246,0.9);
      border-radius: 14px;
      box-shadow: 0 0 0 2000px rgba(0,0,0,0.35);
    }
    #hint {
      position: absolute;
      left: 12px; right: 12px; bottom: 12px;
      background: rgba(11,16,32,0.75);
      border: 1px solid rgba(36,48,86,0.8);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: #cfd6ee;
      backdrop-filter: blur(6px);
    }

    .tag { display: grid; gap: 10px; background: #0b1020; border: 1px dashed #3a4a7a; border-radius: 14px; padding: 14px; }
    .price { font-size: 42px; font-weight: 900; letter-spacing: 0.3px; }
    .muted { color: #aab3cf; font-size: 13px; }
    .kvs { display: grid; gap: 6px; }
    .kv { display: flex; justify-content: space-between; gap: 10px; border-bottom: 1px solid #1a2342; padding: 6px 0; }
    .kv span:first-child { color: #aab3cf; }

    .pill { display: inline-flex; gap: 8px; align-items: center; padding: 6px 10px; border-radius: 999px; background: #0b1020; border: 1px solid #243056; }
    .ok { color: #67f69b; }
    .warn { color: #ffcc66; }
    .bad { color: #ff6b6b; }
    code { background: #0b1020; padding: 2px 6px; border-radius: 8px; border: 1px solid #243056; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .divider { height: 1px; background: #1f2740; margin: 12px 0; }
  </style>
</head>
<body>
<header>
  <h1>Workplace Price Scanner</h1>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content: space-between;">
        <div class="pill" id="statusPill"><span class="warn">●</span><span id="statusText">Ready</span></div>
        <div class="row" style="min-width: 320px;">
          <select id="cameraSelect" aria-label="Camera selection"></select>
          <button class="secondary" id="reloadDbBtn">Reload DB</button>
        </div>
      </div>

      <div style="height: 12px;"></div>

      <div id="videoWrap">
        <video id="video" playsinline muted></video>
        <div id="overlay"><div class="box"></div></div>
        <div id="hint">Tip: hold 6–10 inches away, avoid glare, and keep steady for a second to let autofocus lock.</div>
      </div>

      <div style="height: 12px;"></div>

      <div class="row">
        <button id="startBtn">Start Camera</button>
        <button class="secondary" id="refocusBtn" disabled>Tap to Refocus</button>
        <button class="secondary" id="stopBtn" disabled>Stop</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div style="flex: 1; min-width: 260px;">
          <label class="muted" for="manualInput">Manual barcode lookup</label>
          <input id="manualInput" placeholder="Type / paste a barcode..." inputmode="numeric" />
        </div>
        <div style="width: 180px;">
          <label class="muted" for="qtyInput">Qty</label>
          <input id="qtyInput" type="number" min="1" value="1" />
        </div>
        <div style="width: 180px; align-self: end;">
          <button id="manualBtn" class="secondary" style="width: 100%;">Lookup</button>
        </div>
      </div>
    </section>

    <aside class="card">
      <h2 style="margin: 0 0 10px; font-size: 16px;">Price Tag</h2>

      <div class="tag" id="tag">
        <div class="muted">Scan an item to show its price tag.</div>
      </div>

      <div style="height: 14px;"></div>

      <h3 style="margin: 0 0 8px; font-size: 14px;">Last Scan</h3>
      <div class="kvs">
        <div class="kv"><span>Barcode</span><span id="lastBarcode">—</span></div>
        <div class="kv"><span>Time</span><span id="lastTime">—</span></div>
      </div>

      <div style="height: 14px;"></div>

      <p class="muted" style="margin:0;">
        Loads prices from <code>items.json</code> in your repo.
      </p>
    </aside>
  </div>
</main>

<script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>

<script>
  const ITEMS_DB_URL = "./items.json";
  const SCAN_THROTTLE_MS = 1200;

  const videoEl = document.getElementById("video");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const refocusBtn = document.getElementById("refocusBtn");
  const cameraSelect = document.getElementById("cameraSelect");
  const statusText = document.getElementById("statusText");
  const statusPill = document.getElementById("statusPill");
  const reloadDbBtn = document.getElementById("reloadDbBtn");

  const manualInput = document.getElementById("manualInput");
  const manualBtn = document.getElementById("manualBtn");
  const qtyInput = document.getElementById("qtyInput");

  const tag = document.getElementById("tag");
  const lastBarcode = document.getElementById("lastBarcode");
  const lastTime = document.getElementById("lastTime");

  let itemsMap = new Map();
  let codeReader = null;
  let currentStream = null;
  let activeDeviceId = null;

  let lastScanTs = 0;
  let lastValue = "";

  function setStatus(kind, text) {
    statusText.textContent = text;
    const dot = statusPill.querySelector("span");
    dot.className = kind;
    dot.textContent = "●";
  }

  async function loadDb() {
    setStatus("warn", "Loading DB…");
    try {
      const res = await fetch(ITEMS_DB_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`DB fetch failed: ${res.status}`);
      const arr = await res.json();

      itemsMap = new Map();
      for (const item of (Array.isArray(arr) ? arr : [])) {
        if (item && item.barcode) itemsMap.set(String(item.barcode), item);
      }
      setStatus("ok", `DB loaded (${itemsMap.size} items)`);
    } catch (e) {
      console.error(e);
      setStatus("bad", "DB load error");
      tag.innerHTML = `<div class="muted">Could not load <code>items.json</code>.</div>`;
    }
  }

  function money(n) {
    const v = Number(n);
    if (!Number.isFinite(v)) return "—";
    return v.toLocaleString(undefined, { style: "currency", currency: "USD" });
  }

  function normalizeBarcode(raw) {
    const text = String(raw || "").trim();
    if (/^\d{13}$/.test(text) && text.startsWith("0")) return text.slice(1); // UPC-A as EAN-13
    return text;
  }

  function renderTag(barcode, qty = 1) {
    const key = normalizeBarcode(barcode);

    lastBarcode.textContent = key || "—";
    lastTime.textContent = new Date().toLocaleString();

    const item = itemsMap.get(String(key));
    const q = Math.max(1, parseInt(qty, 10) || 1);

    if (!item) {
      tag.innerHTML = `
        <div class="muted">No match found for barcode:</div>
        <div style="font-size:18px; font-weight:900;" class="mono">${key || "—"}</div>
        <div class="muted">Add it to <code>items.json</code>.</div>
      `;
      return;
    }

    const unit = Number(item.price);
    const total = Number.isFinite(unit) ? unit * q : null;

    tag.innerHTML = `
      <div class="muted">${item.department ? item.department : "Item"}</div>
      <div style="font-size:22px; font-weight:900; line-height:1.15;">${item.name || "Unnamed item"}</div>

      <div class="price">${money(item.price)}</div>

      <div class="kvs">
        <div class="kv"><span>Barcode</span><span class="mono">${key}</span></div>
        ${item.sku ? `<div class="kv"><span>SKU</span><span class="mono">${item.sku}</span></div>` : ""}
        ${item.location ? `<div class="kv"><span>Location</span><span>${item.location}</span></div>` : ""}
        <div class="kv"><span>Qty</span><span>${q}</span></div>
        ${total !== null ? `<div class="kv"><span>Total</span><span>${money(total)}</span></div>` : ""}
      </div>

      ${item.note ? `<div class="muted">Note: ${item.note}</div>` : ""}
    `;
  }

  function buildReader() {
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
      ZXing.BarcodeFormat.UPC_A,
      ZXing.BarcodeFormat.UPC_E,
      ZXing.BarcodeFormat.EAN_13,
      ZXing.BarcodeFormat.EAN_8,
      ZXing.BarcodeFormat.CODE_128,
      ZXing.BarcodeFormat.CODE_39,
      ZXing.BarcodeFormat.ITF
    ]);
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
    return new ZXing.BrowserMultiFormatReader(hints, 200);
  }

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoInputs = devices.filter(d => d.kind === "videoinput");

    cameraSelect.innerHTML = "";
    videoInputs.forEach((d, idx) => {
      const opt = document.createElement("option");
      opt.value = d.deviceId;
      opt.textContent = d.label || `Camera ${idx + 1}`;
      cameraSelect.appendChild(opt);
    });

    if (activeDeviceId) cameraSelect.value = activeDeviceId;
    return videoInputs;
  }

  async function startStreamWithFocus(deviceId) {
    // Stop previous stream
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }

    // Best-effort constraints for iPhone autofocus / quality
    const constraints = {
      audio: false,
      video: {
        deviceId: deviceId ? { exact: deviceId } : undefined,
        facingMode: deviceId ? undefined : { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    };

    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    videoEl.srcObject = currentStream;
    await videoEl.play();

    // Best-effort continuous autofocus
    const track = currentStream.getVideoTracks()[0];
    if (track && track.getCapabilities && track.applyConstraints) {
      const caps = track.getCapabilities();
      // Some iOS versions expose focusMode; if so, request continuous
      if (caps.focusMode) {
        try {
          await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
        } catch {}
      }
    }
  }

  async function startScanner() {
    if (!window.ZXing) { setStatus("bad", "Scanner library missing"); return; }

    setStatus("warn", "Starting camera…");

    // Build reader fresh (helps iOS)
    if (codeReader) { try { codeReader.reset(); } catch {} }
    codeReader = buildReader();

    // Warm-up: request rear cam first so Safari picks environment camera + permissions
    const warm = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    warm.getTracks().forEach(t => t.stop());

    await listCameras().catch(() => {});
    activeDeviceId = cameraSelect.value || null;

    // Start our own stream with focus-friendly constraints
    await startStreamWithFocus(activeDeviceId);

    startBtn.disabled = true;
    stopBtn.disabled = false;
    refocusBtn.disabled = false;

    // Give autofocus a moment to lock before decoding
    setStatus("warn", "Focusing… hold steady");
    await new Promise(r => setTimeout(r, 800));

    setStatus("ok", "Scanning…");

    // Decode from the existing video element stream (still use decodeFromVideoDevice for robustness)
    // Some builds override the video element stream; to avoid fighting, we pass activeDeviceId anyway.
    codeReader.decodeFromVideoDevice(activeDeviceId, videoEl, (result, err) => {
      if (!result) return;

      const text = normalizeBarcode(result.getText());
      const now = Date.now();
      if (text === lastValue && (now - lastScanTs) < SCAN_THROTTLE_MS) return;

      lastValue = text;
      lastScanTs = now;
      renderTag(text, qtyInput.value);
    });
  }

  function stopScanner() {
    try { if (codeReader) codeReader.reset(); } catch {}
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    videoEl.srcObject = null;

    startBtn.disabled = false;
    stopBtn.disabled = true;
    refocusBtn.disabled = true;
    setStatus("warn", "Stopped");
  }

  async function refocus() {
    // iOS web trick: restart the stream to force autofocus to reacquire
    if (!stopBtn.disabled) {
      setStatus("warn", "Refocusing…");
      await startStreamWithFocus(activeDeviceId);
      await new Promise(r => setTimeout(r, 600));
      setStatus("ok", "Scanning…");
    }
  }

  // Events
  startBtn.addEventListener("click", async () => {
    try {
      await loadDb();
      await startScanner();
    } catch (e) {
      console.error(e);
      setStatus("bad", "Camera error");
      startBtn.disabled = false;
      stopBtn.disabled = true;
      refocusBtn.disabled = true;
    }
  });

  stopBtn.addEventListener("click", stopScanner);
  refocusBtn.addEventListener("click", refocus);

  cameraSelect.addEventListener("change", async () => {
    if (stopBtn.disabled) return;
    activeDeviceId = cameraSelect.value || null;
    await refocus();
  });

  reloadDbBtn.addEventListener("click", loadDb);

  manualBtn.addEventListener("click", () => {
    const code = manualInput.value.trim();
    if (code) renderTag(code, qtyInput.value);
  });

  manualInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") manualBtn.click();
  });

  // Init
  loadDb();
</script>
</body>
</html>
