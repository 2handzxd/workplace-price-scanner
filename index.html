<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Workplace Scanner</title>

<style>
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
    background:#0b0d12;
    color:#e8eaf0;
  }
  header{
    padding:14px 16px;
    background:#0f1320;
    border-bottom:1px solid #22283a;
  }
  main{
    max-width:980px;
    margin:auto;
    padding:16px;
  }
  .card{
    background:#11172a;
    border:1px solid #1f2740;
    border-radius:12px;
    padding:14px;
    margin-bottom:14px;
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button,select,input{
    background:#25304f;
    color:#fff;
    border:0;
    padding:10px;
    border-radius:10px;
  }
  button{font-weight:800;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  video{
    width:100%;
    border-radius:12px;
    border:1px solid #223055;
    background:#070a12;
  }
  #scanBox{
    position:absolute;
    top:25%;
    left:10%;
    right:10%;
    height:30%;
    border:3px solid #2b67f6;
    border-radius:12px;
    pointer-events:none;
  }
  .result{
    border:1px dashed #3a4a7a;
    border-radius:12px;
    padding:12px;
  }
  .price{font-size:36px;font-weight:900;margin-top:6px}
  .muted{color:#aab3cf;font-size:13px}
  .hidden{display:none}

  .list{
    margin-top:10px;
    display:grid;
    gap:8px;
  }
  .itemBtn{
    text-align:left;
    background:#1a2342;
    border:1px solid #2b355a;
    padding:10px;
    border-radius:10px;
    color:#e8eaf0;
  }
  .itemBtn:hover{filter:brightness(1.08)}
  .itemTitle{font-weight:900}
  .itemMeta{font-size:12px;color:#aab3cf;margin-top:3px}
  .badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid #3a4a7a;
    margin-left:8px;
    color:#cfd6ee;
  }

  .kv{
    margin-top:10px;
    display:grid;
    gap:6px;
  }
  .kvRow{
    display:flex;
    justify-content:space-between;
    gap:10px;
    border-top:1px solid #1a2342;
    padding-top:6px;
    font-size:13px;
  }
  .kvRow span:first-child{color:#aab3cf}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  img.product{
    width:100%;
    max-height:260px;
    object-fit:contain;
    border-radius:12px;
    border:1px solid #223055;
    background:#070a12;
  }
</style>
</head>

<body>
<header>
  <h2>Workplace Barcode / SKU Scanner</h2>
</header>

<main>

<!-- CAMERA -->
<div class="card">
  <div class="row">
    <select id="cameraSelect">
      <option value="environment">Back Camera</option>
      <option value="user">Front Camera</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="focusBtn" disabled>Focus</button>
    <button id="torchBtn" disabled>Flashlight</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div style="position:relative;margin-top:10px">
    <video id="video" playsinline muted></video>
    <div id="scanBox"></div>
  </div>

  <div class="muted" style="margin-top:8px">
    Tip: keep barcode flat, fill most of the blue box, avoid glare.
  </div>
</div>

<!-- LOOKUP -->
<div class="card">
  <h3>Manual Lookup</h3>

  <div class="row">
    <input id="skuLookup" placeholder="Lookup by SKU / Barcode" style="flex:1;min-width:220px">
    <button id="skuBtn">Lookup SKU</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="nameLookup" placeholder="Search by name/keywords (e.g., eagle)" style="flex:1;min-width:220px">
    <button id="nameBtn">Search</button>
    <button id="clearSearchBtn">Clear</button>
  </div>

  <div id="matches" class="list"></div>
</div>

<!-- RESULT -->
<div class="card">
  <h3>Result</h3>
  <div id="result" class="result muted">Loading database…</div>
</div>

<!-- UNKNOWN -->
<div class="card hidden" id="unknownCard">
  <h3>Register Unknown Product</h3>

  <div class="row">
    <input id="u_name" placeholder="Product name" style="flex:1;min-width:220px">
    <input id="u_price" type="number" step="0.01" placeholder="Price" style="width:160px">
  </div>

  <div class="row" style="margin-top:10px">
    <input id="u_dept" placeholder="Department" style="flex:1;min-width:220px">
    <input id="u_location" placeholder="Location (optional)" style="flex:1;min-width:220px">
  </div>

  <div class="row" style="margin-top:10px">
    <input id="u_note" placeholder="Note/description (optional)" style="flex:1;min-width:220px">
  </div>

  <div class="row" style="margin-top:10px">
    <input id="u_image" placeholder="Image path (e.g., images/eagle-brand-medicated-oil.jpg)" style="flex:1;min-width:220px">
  </div>

  <button id="saveUnknown" style="margin-top:10px">Save Product</button>
  <div class="muted" style="margin-top:8px">
    Saves into the downloadable <span class="mono">items.json</span>. You’ll still need to commit it to GitHub.
  </div>
</div>

<button id="exportBtn" class="hidden">Download updated items.json</button>

</main>

<script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>

<script>
  const ITEMS_URL = "./items.json";

  const video = document.getElementById("video");
  const resultEl = document.getElementById("result");
  const unknownCard = document.getElementById("unknownCard");
  const exportBtn = document.getElementById("exportBtn");
  const matchesEl = document.getElementById("matches");

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const focusBtn = document.getElementById("focusBtn");
  const torchBtn = document.getElementById("torchBtn");
  const cameraSelect = document.getElementById("cameraSelect");

  const skuLookup = document.getElementById("skuLookup");
  const nameLookup = document.getElementById("nameLookup");

  // Unknown form inputs
  const uName = document.getElementById("u_name");
  const uPrice = document.getElementById("u_price");
  const uDept = document.getElementById("u_dept");
  const uLoc = document.getElementById("u_location");
  const uNote = document.getElementById("u_note");
  const uImage = document.getElementById("u_image");

  let items = [];
  let itemsMap = new Map();
  let reader = null, stream = null, track = null;
  let lastCode = "";

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadItems(){
    const res = await fetch(ITEMS_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("Failed to load items.json: " + res.status);
    items = await res.json();
    itemsMap = new Map(items.map(i => [String(i.barcode), i]));
  }

  function displayItem(item){
    const name = item.name || "Unnamed";
    const dept = item.department || "";
    const loc  = item.location || "—";
    const note = item.note || "";
    const bc   = String(item.barcode || "");
    const img  = item.image ? String(item.image) : "";

    resultEl.innerHTML = `
      ${img ? `
        <div style="margin-bottom:10px;">
          <img class="product" src="${escapeHtml(img)}" alt="${escapeHtml(name)}"
               onerror="this.style.display='none';">
        </div>
      ` : ""}

      <div class="itemTitle">${escapeHtml(name)}</div>
      <div class="muted">${escapeHtml(dept)}</div>
      <div class="price">$${escapeHtml(item.price)}</div>

      <div class="kv">
        <div class="kvRow"><span>Barcode/SKU</span><span class="mono"><b>${escapeHtml(bc)}</b></span></div>
        <div class="kvRow"><span>Location</span><span><b>${escapeHtml(loc)}</b></span></div>
        ${note ? `<div class="kvRow"><span>Note</span><span>${escapeHtml(note)}</span></div>` : ""}
      </div>
    `;

    unknownCard.classList.add("hidden");
  }

  function handleCode(code){
    lastCode = String(code).trim();
    const item = itemsMap.get(lastCode);

    if(item){
      displayItem(item);
      matchesEl.innerHTML = "";
    } else {
      resultEl.innerHTML = `<b>Unknown SKU:</b><br><span class="mono">${escapeHtml(lastCode)}</span>`;
      unknownCard.classList.remove("hidden");
    }
  }

  // ---------- SEARCH ----------
  function searchableText(item){
    return [
      item.barcode,
      item.name,
      item.note,
      item.department,
      item.location
    ].filter(Boolean).join(" ").toLowerCase();
  }

  function renderMatches(list, query){
    matchesEl.innerHTML = "";
    if(!query) return;

    if(list.length === 0){
      matchesEl.innerHTML = `<div class="muted">No matches for "${escapeHtml(query)}"</div>`;
      return;
    }

    const shown = list.slice(0, 30);
    for(const item of shown){
      const btn = document.createElement("button");
      btn.className = "itemBtn";
      btn.type = "button";

      const img = item.image ? String(item.image) : "";

      btn.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;">
          ${img ? `
            <img src="${escapeHtml(img)}" alt="${escapeHtml(item.name || "Item")}"
                 style="width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid #223055;background:#070a12"
                 onerror="this.style.display='none';">
          ` : `
            <div style="width:56px;height:56px;border-radius:10px;border:1px solid #223055;background:#070a12;"></div>
          `}
          <div style="flex:1;">
            <div class="itemTitle">
              ${escapeHtml(item.name || "Unnamed")}
              <span class="badge">$${escapeHtml(item.price)}</span>
            </div>
            <div class="itemMeta">
              SKU: <b>${escapeHtml(item.barcode)}</b>
              ${item.department ? ` • ${escapeHtml(item.department)}` : ""}
              ${item.location ? ` • ${escapeHtml(item.location)}` : ""}
            </div>
          </div>
        </div>
      `;
      btn.onclick = () => displayItem(item);
      matchesEl.appendChild(btn);
    }

    if(list.length > shown.length){
      const more = document.createElement("div");
      more.className = "muted";
      more.textContent = `Showing ${shown.length} of ${list.length} matches. Narrow your search to see more.`;
      matchesEl.appendChild(more);
    }
  }

  function searchByName(){
    const q = nameLookup.value.trim().toLowerCase();
    if(!q){
      matchesEl.innerHTML = `<div class="muted">Type a keyword (example: <b>eagle</b>)</div>`;
      return;
    }

    const results = items
      .map(item => ({ item, text: searchableText(item) }))
      .filter(x => x.text.includes(q))
      .map(x => x.item);

    renderMatches(results, q);
  }

  let searchTimer = null;
  nameLookup.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(searchByName, 120);
  });

  document.getElementById("nameBtn").onclick = searchByName;
  document.getElementById("clearSearchBtn").onclick = () => {
    nameLookup.value = "";
    matchesEl.innerHTML = "";
  };

  // SKU lookup
  document.getElementById("skuBtn").onclick = () => {
    const v = skuLookup.value.trim();
    if(v) handleCode(v);
  };
  skuLookup.addEventListener("keydown", (e) => {
    if(e.key === "Enter") document.getElementById("skuBtn").click();
  });

  // ---------- CAMERA ----------
  async function start(){
    // Don’t reload DB here — searches should work without camera
    const hints = new Map();
    hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

    reader = new ZXing.BrowserMultiFormatReader(hints);

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: cameraSelect.value }
    });

    video.srcObject = stream;
    await video.play();

    track = stream.getVideoTracks()[0];

    // Torch support (often not exposed on iOS Safari)
    torchBtn.disabled = !(track.getCapabilities?.().torch === true);

    focusBtn.disabled = false;
    stopBtn.disabled = false;
    startBtn.disabled = true;

    reader.decodeFromVideoElement(video, (res) => {
      if(res) handleCode(res.getText());
    });
  }

  function stop(){
    try { reader?.reset(); } catch {}
    try { stream?.getTracks().forEach(t => t.stop()); } catch {}
    reader = null; stream = null; track = null;

    startBtn.disabled = false;
    stopBtn.disabled = true;
    torchBtn.disabled = true;
    focusBtn.disabled = true;
  }

  async function focus(){
    if(!track?.applyConstraints) return;
    try{
      await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
    }catch{}
  }

  async function torch(){
    if(!track?.applyConstraints) return;
    try{
      track._torchOn = !track._torchOn;
      await track.applyConstraints({ advanced: [{ torch: track._torchOn }] });
    }catch{
      torchBtn.disabled = true;
    }
  }

  startBtn.onclick = start;
  stopBtn.onclick = stop;
  focusBtn.onclick = focus;
  torchBtn.onclick = torch;

  cameraSelect.addEventListener("change", async () => {
    if(stream){
      stop();
      await start();
    }
  });

  // ---------- UNKNOWN save + export ----------
  document.getElementById("saveUnknown").onclick = () => {
    const name = uName.value.trim();
    const price = Number(uPrice.value);
    const dept = uDept.value.trim();
    const loc  = uLoc.value.trim();
    const note = uNote.value.trim();
    const img  = uImage.value.trim();

    if(!lastCode) return alert("No scanned code to save.");
    if(!name) return alert("Name required.");
    if(!Number.isFinite(price)) return alert("Price must be a number.");

    const item = {
      barcode: lastCode,
      name,
      department: dept || "",
      price: Math.round(price * 100) / 100,
      location: loc || "",
      note: note || "",
      ...(img ? { image: img } : {})
    };

    items.push(item);
    itemsMap.set(lastCode, item);
    exportBtn.classList.remove("hidden");
    displayItem(item);
    alert("Saved. Download updated items.json and commit it to GitHub.");
  };

  exportBtn.onclick = () => {
    const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "items.json";
    a.click();
  };

  // ---------- INIT ----------
  (async () => {
    try{
      await loadItems();
      resultEl.textContent = "Database loaded. Ready to search or scan.";
    }catch(e){
      resultEl.textContent = "Failed to load items.json. Make sure it is in the repo root.";
      console.error(e);
    }
  })();
</script>

</body>
</html>
