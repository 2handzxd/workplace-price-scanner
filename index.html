<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Workplace Scanner</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:#0b0d12;
  color:#e8eaf0;
}
header{
  padding:14px 16px;
  background:#0f1320;
  border-bottom:1px solid #22283a;
}
main{
  max-width:900px;
  margin:auto;
  padding:16px;
}
.card{
  background:#11172a;
  border:1px solid #1f2740;
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button,select,input{
  background:#25304f;
  color:#fff;
  border:0;
  padding:10px;
  border-radius:10px;
}
button{font-weight:700;cursor:pointer}
button:disabled{opacity:.6;cursor:not-allowed}
video{
  width:100%;
  border-radius:12px;
  border:1px solid #223055;
}
#scanBox{
  position:absolute;
  top:25%;
  left:10%;
  right:10%;
  height:30%;
  border:3px solid #2b67f6;
  border-radius:12px;
  pointer-events:none;
}
.result{
  border:1px dashed #3a4a7a;
  border-radius:12px;
  padding:12px;
}
.price{font-size:36px;font-weight:900}
.muted{color:#aab3cf;font-size:13px}
.hidden{display:none}

.list{
  margin-top:10px;
  display:grid;
  gap:8px;
}
.itemBtn{
  text-align:left;
  background:#1a2342;
  border:1px solid #2b355a;
  padding:10px;
  border-radius:10px;
  color:#e8eaf0;
}
.itemBtn:hover{filter:brightness(1.08)}
.itemTitle{font-weight:800}
.itemMeta{font-size:12px;color:#aab3cf;margin-top:3px}
.badge{
  display:inline-block;
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid #3a4a7a;
  margin-left:8px;
  color:#cfd6ee;
}
</style>
</head>

<body>
<header>
  <h2>Workplace Barcode / SKU Scanner</h2>
</header>

<main>

<!-- CAMERA -->
<div class="card">
  <div class="row">
    <select id="cameraSelect">
      <option value="environment">Back Camera</option>
      <option value="user">Front Camera</option>
    </select>
    <button id="startBtn">Start</button>
    <button id="focusBtn" disabled>Focus</button>
    <button id="torchBtn" disabled>Flashlight</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>

  <div style="position:relative;margin-top:10px">
    <video id="video" playsinline muted></video>
    <div id="scanBox"></div>
  </div>
</div>

<!-- LOOKUP -->
<div class="card">
  <h3>Manual Lookup</h3>

  <div class="row">
    <input id="skuLookup" placeholder="Lookup by SKU / Barcode" style="flex:1;min-width:220px">
    <button id="skuBtn">Lookup SKU</button>
  </div>

  <div class="row" style="margin-top:10px">
    <input id="nameLookup" placeholder="Search by name/keywords (e.g., eagle)" style="flex:1;min-width:220px">
    <button id="nameBtn">Search</button>
    <button id="clearSearchBtn" class="secondary">Clear</button>
  </div>

  <div id="matches" class="list"></div>
</div>

<!-- RESULT -->
<div class="card">
  <h3>Result</h3>
  <div id="result" class="result muted">Waiting for scan or lookup…</div>
</div>

<!-- UNKNOWN -->
<div class="card hidden" id="unknownCard">
  <h3>Register Unknown Product</h3>
  <div class="row">
    <input id="u_name" placeholder="Product name" style="flex:1;min-width:220px">
    <input id="u_price" type="number" step="0.01" placeholder="Price" style="width:160px">
  </div>
  <div class="row" style="margin-top:10px">
    <input id="u_dept" placeholder="Department" style="flex:1;min-width:220px">
    <input id="u_location" placeholder="Location (optional)" style="flex:1;min-width:220px">
  </div>
  <div class="row" style="margin-top:10px">
    <input id="u_note" placeholder="Note/description (optional)" style="flex:1;min-width:220px">
  </div>
  <button id="saveUnknown" style="margin-top:10px">Save Product</button>
</div>

<button id="exportBtn" class="hidden">Download updated items.json</button>

</main>

<script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>

<script>
const video = document.getElementById("video");
const resultEl = document.getElementById("result");
const unknownCard = document.getElementById("unknownCard");
const exportBtn = document.getElementById("exportBtn");
const matchesEl = document.getElementById("matches");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const focusBtn = document.getElementById("focusBtn");
const torchBtn = document.getElementById("torchBtn");
const cameraSelect = document.getElementById("cameraSelect");

const skuLookup = document.getElementById("skuLookup");
const nameLookup = document.getElementById("nameLookup");

let items = [];
let itemsMap = new Map();
let reader, stream, track;
let lastCode = "";

// ---------- DB ----------
async function loadItems(){
  const res = await fetch("./items.json", { cache:"no-store" });
  items = await res.json();
  itemsMap = new Map(items.map(i => [String(i.barcode), i]));
}

// ---------- UI ----------
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function displayItem(item){
  resultEl.innerHTML = `
    <div class="price">$${item.price}</div>
    <div class="itemTitle">${escapeHtml(item.name || "Unnamed")}</div>
    <div class="muted">
      ${escapeHtml(item.department || "")}
      ${item.location ? ` • ${escapeHtml(item.location)}` : ""}
    </div>
    <div class="muted mono" style="margin-top:6px">
      Barcode/SKU: <b>${escapeHtml(item.barcode)}</b>
    </div>
    ${item.note ? `<div class="muted" style="margin-top:6px">Note: ${escapeHtml(item.note)}</div>` : ""}
  `;
  unknownCard.classList.add("hidden");
}

function handleCode(code){
  lastCode = String(code).trim();
  const item = itemsMap.get(lastCode);
  if(item){
    displayItem(item);
    matchesEl.innerHTML = ""; // optional: clear matches after selection
  } else {
    resultEl.innerHTML = `<b>Unknown SKU:</b><br>${escapeHtml(lastCode)}`;
    unknownCard.classList.remove("hidden");
  }
}

// ---------- SEARCH ----------
function searchableText(item){
  return [
    item.barcode,
    item.name,
    item.note,
    item.department,
    item.location,
    item.Section,      // if your JSON uses Section
    item.section
  ].filter(Boolean).join(" ").toLowerCase();
}

function renderMatches(list, query){
  matchesEl.innerHTML = "";
  if(!query){
    return;
  }
  if(list.length === 0){
    matchesEl.innerHTML = `<div class="muted">No matches for "${escapeHtml(query)}"</div>`;
    return;
  }

  // cap results so it stays usable on phone
  const shown = list.slice(0, 30);

  for(const item of shown){
    const btn = document.createElement("button");
    btn.className = "itemBtn";
    btn.type = "button";
    btn.innerHTML = `
      <div class="itemTitle">
        ${escapeHtml(item.name || "Unnamed")}
        <span class="badge">$${escapeHtml(item.price)}</span>
      </div>
      <div class="itemMeta">
        SKU: <b>${escapeHtml(item.barcode)}</b>
        ${item.department ? ` • ${escapeHtml(item.department)}` : ""}
        ${item.location ? ` • ${escapeHtml(item.location)}` : ""}
      </div>
    `;
    btn.onclick = () => displayItem(item);
    matchesEl.appendChild(btn);
  }

  if(list.length > shown.length){
    const more = document.createElement("div");
    more.className = "muted";
    more.textContent = `Showing ${shown.length} of ${list.length} matches. Narrow your search to see more.`;
    matchesEl.appendChild(more);
  }
}

function searchByName(){
  const q = nameLookup.value.trim().toLowerCase();
  if(!q){
    matchesEl.innerHTML = `<div class="muted">Type a keyword (example: <b>eagle</b>)</div>`;
    return;
  }

  const results = items
    .map(item => ({ item, text: searchableText(item) }))
    .filter(x => x.text.includes(q))
    .map(x => x.item);

  renderMatches(results, q);
}

// live search as you type (fast enough for typical JSON sizes)
let searchTimer = null;
nameLookup.addEventListener("input", () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(searchByName, 120);
});

document.getElementById("nameBtn").onclick = searchByName;
document.getElementById("clearSearchBtn").onclick = () => {
  nameLookup.value = "";
  matchesEl.innerHTML = "";
};

// ---------- SKU lookup ----------
document.getElementById("skuBtn").onclick = () => {
  const v = skuLookup.value.trim();
  if(v) handleCode(v);
};
skuLookup.addEventListener("keydown", (e) => {
  if(e.key === "Enter") document.getElementById("skuBtn").click();
});

// ---------- CAMERA ----------
async function start(){
  await loadItems();

  const hints = new Map();
  hints.set(ZXing.DecodeHintType.TRY_HARDER, true);

  reader = new ZXing.BrowserMultiFormatReader(hints);

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: cameraSelect.value }
  });

  video.srcObject = stream;
  await video.play();

  track = stream.getVideoTracks()[0];

  // torch support (often not exposed on iOS Safari)
  torchBtn.disabled = !(track.getCapabilities?.().torch === true);

  focusBtn.disabled = false;
  stopBtn.disabled = false;
  startBtn.disabled = true;

  reader.decodeFromVideoElement(video, (res) => {
    if(res) handleCode(res.getText());
  });
}

function stop(){
  try { reader?.reset(); } catch {}
  try { stream?.getTracks().forEach(t => t.stop()); } catch {}
  startBtn.disabled = false;
  stopBtn.disabled = true;
  torchBtn.disabled = true;
  focusBtn.disabled = true;
}

async function focus(){
  if(!track?.applyConstraints) return;
  try{
    // Best-effort: request continuous autofocus
    await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
  }catch{
    // Some devices ignore/deny; no-op
  }
}

async function torch(){
  if(!track?.applyConstraints) return;
  try{
    track._torchOn = !track._torchOn;
    await track.applyConstraints({ advanced: [{ torch: track._torchOn }] });
  }catch{
    // If it fails, disable button
    torchBtn.disabled = true;
  }
}

startBtn.onclick = start;
stopBtn.onclick = stop;
focusBtn.onclick = focus;
torchBtn.onclick = torch;

cameraSelect.addEventListener("change", async () => {
  // restart camera when switching front/back
  if(stream){
    stop();
    await start();
  }
});

// ---------- UNKNOWN save + export ----------
document.getElementById("saveUnknown").onclick = () => {
  const name = document.getElementById("u_name").value.trim();
  const price = Number(document.getElementById("u_price").value);
  const dept = document.getElementById("u_dept").value.trim();
  const loc  = document.getElementById("u_location").value.trim();
  const note = document.getElementById("u_note").value.trim();

  if(!lastCode) return alert("No scanned code to save.");
  if(!name) return alert("Name required.");
  if(!Number.isFinite(price)) return alert("Price must be a number.");

  const item = {
    barcode: lastCode,
    name,
    price: Math.round(price * 100) / 100,
    ...(dept ? { department: dept } : {}),
    ...(loc ? { location: loc } : {}),
    ...(note ? { note } : {})
  };

  items.push(item);
  itemsMap.set(lastCode, item);
  exportBtn.classList.remove("hidden");
  displayItem(item);
  alert("Saved locally. Download updated items.json and commit it to GitHub.");
};

exportBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(items, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "items.json";
  a.click();
};
</script>

</body>
</html>
